<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·å¤‰æ› - éŸ³å£°å…¥åŠ›å¯¾å¿œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: calc(20px + var(--safe-top)) 20px calc(20px + var(--safe-bottom));
            overflow-x: hidden;
        }

        .container {
            max-width: 390px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 22px;
            margin-bottom: 6px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-bottom: 16px;
        }

        /* éŸ³å£°å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .voice-section {
            background: linear-gradient(135deg, rgba(123,44,191,0.3), rgba(0,212,255,0.2));
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            text-align: center;
            border: 1px solid rgba(123,44,191,0.4);
        }

        .mic-btn {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            background: linear-gradient(135deg, #7b2cbf, #5a189a);
            color: #fff;
            font-size: 36px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(123,44,191,0.4);
            position: relative;
            -webkit-user-select: none;
            user-select: none;
        }

        .mic-btn:active {
            transform: scale(0.95);
        }

        .mic-btn.listening {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            border-color: #ff6b6b;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255,71,87,0.7); }
            50% { box-shadow: 0 0 0 20px rgba(255,71,87,0); }
        }

        .mic-btn.processing {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            border-color: #00d4ff;
        }

        .mic-btn.requesting {
            background: linear-gradient(135deg, #ffa502, #ff7f50);
            border-color: #ffa502;
        }

        .mic-btn.error {
            background: linear-gradient(135deg, #666, #444);
            border-color: #888;
        }

        .voice-status {
            margin-top: 14px;
            font-size: 15px;
            color: #b388ff;
            min-height: 24px;
            font-weight: 500;
            line-height: 1.4;
        }

        .voice-status.error {
            color: #ff6b6b;
        }

        .voice-status.success {
            color: #4cd137;
        }

        .voice-status.warning {
            color: #ffa502;
        }

        .recognized-text {
            margin-top: 14px;
            padding: 14px;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            font-size: 18px;
            color: #fff;
            min-height: 50px;
            text-align: left;
            line-height: 1.5;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .recognized-text:empty::before {
            content: "èªè­˜çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™";
            color: #666;
            font-size: 14px;
        }

        .recognized-text.interim {
            color: #aaa;
            font-style: italic;
        }

        .auto-play-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 14px;
            font-size: 14px;
            color: #ccc;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 28px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* æ¨©é™ã‚¬ã‚¤ãƒ‰ */
        .permission-guide {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: rgba(255,165,2,0.2);
            border: 1px solid rgba(255,165,2,0.4);
            border-radius: 12px;
            font-size: 12px;
            color: #ffd43b;
            text-align: left;
            line-height: 1.6;
        }

        .permission-guide.show {
            display: block;
        }

        .permission-guide ol {
            margin: 8px 0 0 20px;
        }

        /* å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .input-section {
            background: rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            backdrop-filter: blur(10px);
        }

        .input-label {
            font-size: 13px;
            color: #aaa;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        textarea {
            width: 100%;
            height: 80px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            color: #fff;
            font-size: 16px;
            resize: none;
            outline: none;
            transition: border-color 0.3s;
        }

        textarea:focus {
            border-color: #00d4ff;
        }

        textarea::placeholder {
            color: #666;
        }

        .reading-section {
            background: rgba(123, 44, 191, 0.2);
            border: 1px solid rgba(123, 44, 191, 0.4);
            border-radius: 12px;
            padding: 10px;
            margin-top: 10px;
        }

        .reading-label {
            font-size: 11px;
            color: #b388ff;
            margin-bottom: 4px;
        }

        .reading-text {
            font-size: 14px;
            color: #e1bee7;
            line-height: 1.5;
            word-break: break-all;
        }

        .morse-output {
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 14px;
            min-height: 60px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            letter-spacing: 3px;
            word-break: break-all;
            line-height: 1.6;
            color: #00d4ff;
        }

        /* ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ */
        .visualizer {
            height: 70px;
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .signal-light {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #333;
            transition: all 0.05s;
            box-shadow: 0 0 0 rgba(0,212,255,0);
        }

        .signal-light.active {
            background: #00d4ff;
            box-shadow: 0 0 40px rgba(0,212,255,0.9), 0 0 80px rgba(0,212,255,0.5);
        }

        .current-char {
            font-size: 28px;
            color: #fff;
            margin-right: 20px;
            min-width: 40px;
            text-align: center;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn-play {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
        }

        .btn-play:disabled {
            background: #444;
            color: #888;
        }

        .btn-stop {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: #fff;
        }

        .btn-clear {
            background: rgba(255,255,255,0.1);
            color: #fff;
            flex: 0.5;
        }

        /* è¨­å®š */
        .settings {
            background: rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .setting-row:not(:last-child) {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .setting-label {
            font-size: 13px;
            color: #ccc;
        }

        .setting-value {
            font-size: 13px;
            color: #00d4ff;
            font-weight: 600;
            min-width: 35px;
            text-align: right;
        }

        input[type="range"] {
            width: 100px;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #00d4ff;
            border-radius: 50%;
            cursor: pointer;
        }

        .status {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }

        .status.playing {
            color: #00d4ff;
        }

        /* ãƒ¢ãƒ¼ãƒ«ã‚¹è¡¨ */
        .reference {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 14px;
            margin-top: 16px;
        }

        .reference h3 {
            font-size: 13px;
            color: #888;
            margin-bottom: 10px;
            text-align: center;
        }

        .tab-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #888;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: rgba(0,212,255,0.2);
            color: #00d4ff;
        }

        .morse-table {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            font-size: 10px;
        }

        .morse-item {
            background: rgba(0,0,0,0.3);
            padding: 5px 3px;
            border-radius: 5px;
            text-align: center;
        }

        .morse-item .char {
            color: #fff;
            font-weight: bold;
            font-size: 11px;
        }

        .morse-item .code {
            color: #00d4ff;
            font-family: monospace;
            font-size: 9px;
            margin-top: 1px;
        }

        .hint {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 12px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¡ ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·å¤‰æ›</h1>
        <p class="subtitle">ğŸ¤ éŸ³å£°å…¥åŠ›å¯¾å¿œ - æ¼¢å­—ãƒ»ã²ã‚‰ãŒãªãƒ»è‹±æ•°å­—</p>

        <!-- éŸ³å£°å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="voice-section">
            <button class="mic-btn" id="micBtn" type="button">ğŸ¤</button>
            <div class="voice-status" id="voiceStatus">ã‚¿ãƒƒãƒ—ã—ã¦ãƒã‚¤ã‚¯ã‚’è¨±å¯</div>
            <div class="recognized-text" id="recognizedText"></div>
            
            <div class="permission-guide" id="permissionGuide">
                <strong>âš ï¸ ãƒã‚¤ã‚¯ã‚’è¨±å¯ã™ã‚‹æ–¹æ³•:</strong>
                <ol>
                    <li>ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã®ã€Œãã‚ã€ã‚’ã‚¿ãƒƒãƒ—</li>
                    <li>ã€ŒWebã‚µã‚¤ãƒˆã®è¨­å®šã€ã‚’ã‚¿ãƒƒãƒ—</li>
                    <li>ã€Œãƒã‚¤ã‚¯ã€ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´</li>
                    <li>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿</li>
                </ol>
            </div>
            
            <div class="auto-play-toggle">
                <span>èªè­˜å¾Œã«è‡ªå‹•å†ç”Ÿ</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoPlayToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› -->
        <div class="input-section">
            <div class="input-label">
                <span>âœï¸</span>
                ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼ˆæ‰‹å‹•ï¼‰
            </div>
            <textarea id="textInput" placeholder="ã¾ãŸã¯ã€ã“ã“ã«ç›´æ¥å…¥åŠ›..."></textarea>
            
            <div class="reading-section" id="readingSection" style="display: none;">
                <div class="reading-label">ğŸ“– èª­ã¿ä»®å</div>
                <div class="reading-text" id="readingText"></div>
            </div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ«ã‚¹å‡ºåŠ› -->
        <div class="input-section">
            <div class="input-label">
                <span>ğŸ“¶</span>
                ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·
            </div>
            <div class="morse-output" id="morseOutput">-</div>
        </div>

        <!-- ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ -->
        <div class="visualizer">
            <span class="current-char" id="currentChar"></span>
            <div class="signal-light" id="signalLight"></div>
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="controls">
            <button class="btn btn-play" id="playBtn">â–¶ï¸ å†ç”Ÿ</button>
            <button class="btn btn-stop" id="stopBtn">â¹ï¸ åœæ­¢</button>
            <button class="btn btn-clear" id="clearBtn">ğŸ—‘ï¸</button>
        </div>

        <div class="status" id="status">å…¥åŠ›ã—ã¦ãã ã•ã„</div>

        <!-- è¨­å®š -->
        <div class="settings">
            <div class="setting-row">
                <span class="setting-label">é€Ÿåº¦ (WPM)</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="range" id="speedSlider" min="5" max="30" value="12">
                    <span class="setting-value" id="speedValue">12</span>
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">å‘¨æ³¢æ•° (Hz)</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="range" id="freqSlider" min="400" max="1000" value="700">
                    <span class="setting-value" id="freqValue">700</span>
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">éŸ³é‡</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="range" id="volumeSlider" min="0" max="100" value="70">
                    <span class="setting-value" id="volumeValue">70%</span>
                </div>
            </div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ«ã‚¹è¡¨ -->
        <div class="reference">
            <h3>ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·è¡¨</h3>
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="alpha">è‹±æ•°å­—</button>
                <button class="tab-btn" data-tab="kana">ã‚«ã‚¿ã‚«ãƒŠ</button>
            </div>
            <div class="morse-table" id="morseTable"></div>
        </div>

        <div class="hint">
            ğŸ’¡ ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã™ã¨<br>è‡ªå‹•ã§ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã«å¤‰æ›ã•ã‚Œã¾ã™
        </div>
    </div>

    <script>
        // ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ãƒãƒƒãƒ”ãƒ³ã‚°
        const MORSE_CODE = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
            'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
            'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
            'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..',
            '0': '-----', '1': '.----', '2': '..---', '3': '...--', '4': '....-',
            '5': '.....', '6': '-....', '7': '--...', '8': '---..', '9': '----.',
            '.': '.-.-.-', ',': '--..--', '?': '..--..', '!': '-.-.--', ' ': ' '
        };

        const MORSE_KANA = {
            'ã‚¢': '--.--', 'ã‚¤': '.-', 'ã‚¦': '..-', 'ã‚¨': '-.---', 'ã‚ª': '.-...',
            'ã‚«': '.-..', 'ã‚­': '-.-..', 'ã‚¯': '...-', 'ã‚±': '-.--', 'ã‚³': '----',
            'ã‚µ': '-.-.-', 'ã‚·': '--.-.', 'ã‚¹': '---.-', 'ã‚»': '.---.', 'ã‚½': '---.',
            'ã‚¿': '-.', 'ãƒ': '..-.', 'ãƒ„': '.--.', 'ãƒ†': '.-.--', 'ãƒˆ': '..-..',
            'ãƒŠ': '.-.', 'ãƒ‹': '-.-.', 'ãƒŒ': '....', 'ãƒ': '--.-', 'ãƒ': '..--',
            'ãƒ': '-...', 'ãƒ’': '--..-', 'ãƒ•': '--..', 'ãƒ˜': '.', 'ãƒ›': '-..',
            'ãƒ': '-..-', 'ãƒŸ': '..-.-', 'ãƒ ': '-', 'ãƒ¡': '-...-', 'ãƒ¢': '-..-.',
            'ãƒ¤': '.--', 'ãƒ¦': '-..--', 'ãƒ¨': '--',
            'ãƒ©': '...', 'ãƒª': '--.', 'ãƒ«': '-.--.', 'ãƒ¬': '---', 'ãƒ­': '.-.-',
            'ãƒ¯': '-.-', 'ãƒ²': '.---', 'ãƒ³': '.-.-.',
            'ã‚¬': '.-.. ..', 'ã‚®': '-.-.. ..', 'ã‚°': '...- ..', 'ã‚²': '-.-- ..', 'ã‚´': '---- ..',
            'ã‚¶': '-.-.- ..', 'ã‚¸': '--.-. ..', 'ã‚º': '---.- ..', 'ã‚¼': '.---. ..', 'ã‚¾': '---. ..',
            'ãƒ€': '-. ..', 'ãƒ‚': '..-. ..', 'ãƒ…': '.--. ..', 'ãƒ‡': '.-.-- ..', 'ãƒ‰': '..-.. ..',
            'ãƒ': '-... ..', 'ãƒ“': '--..- ..', 'ãƒ–': '--.. ..', 'ãƒ™': '. ..', 'ãƒœ': '-.. ..',
            'ãƒ‘': '-... ..-..', 'ãƒ”': '--..- ..-..', 'ãƒ—': '--.. ..-..', 'ãƒš': '. ..-..', 'ãƒ': '-.. ..-..',
            'ã‚¡': '--.--', 'ã‚£': '.-', 'ã‚¥': '..-', 'ã‚§': '-.---', 'ã‚©': '.-...',
            'ãƒ£': '.--', 'ãƒ¥': '-..--', 'ãƒ§': '--', 'ãƒƒ': '.--.',
            'ãƒ¼': '.--.-', 'ã€': '.-.-.-', 'ã€‚': '.-.-..'
        };

        function hiraganaToKatakana(str) {
            return str.replace(/[\u3041-\u3096]/g, m => String.fromCharCode(m.charCodeAt(0) + 0x60));
        }

        const KANJI_DICT = {
            'å¤§ä¸ˆå¤«': 'ãƒ€ã‚¤ã‚¸ãƒ§ã‚¦ãƒ–', 'è‡ªè»¢è»Š': 'ã‚¸ãƒ†ãƒ³ã‚·ãƒ£', 'é£›è¡Œæ©Ÿ': 'ãƒ’ã‚³ã‚¦ã‚­',
            'ã‚ã‚ŠãŒã¨ã†': 'ã‚¢ãƒªã‚¬ãƒˆã‚¦', 'ã“ã‚“ã«ã¡ã¯': 'ã‚³ãƒ³ãƒ‹ãƒãƒ', 'ãŠã¯ã‚ˆã†': 'ã‚ªãƒãƒ¨ã‚¦',
            'ã“ã‚“ã°ã‚“ã¯': 'ã‚³ãƒ³ãƒãƒ³ãƒ', 'ã•ã‚ˆã†ãªã‚‰': 'ã‚µãƒ¨ã‚¦ãƒŠãƒ©', 'ã™ã¿ã¾ã›ã‚“': 'ã‚¹ãƒŸãƒã‚»ãƒ³',
            'ä»Šæ—¥ã¯': 'ã‚­ãƒ§ã‚¦ãƒ', 'æ˜æ—¥ã¯': 'ã‚¢ã‚·ã‚¿ãƒ', 'æ—¥æœ¬èª': 'ãƒ‹ãƒ›ãƒ³ã‚´',
            'å­ä¾›': 'ã‚³ãƒ‰ãƒ¢', 'å‹é”': 'ãƒˆãƒ¢ãƒ€ãƒ', 'å¤©æ°—': 'ãƒ†ãƒ³ã‚­', 'æ—¥æœ¬': 'ãƒ‹ãƒ›ãƒ³',
            'å ´æ‰€': 'ãƒã‚·ãƒ§', 'åå‰': 'ãƒŠãƒã‚¨', 'ä»•äº‹': 'ã‚·ã‚´ãƒˆ', 'å•é¡Œ': 'ãƒ¢ãƒ³ãƒ€ã‚¤',
            'è³ªå•': 'ã‚·ãƒ„ãƒ¢ãƒ³', 'æ„å‘³': 'ã‚¤ãƒŸ', 'ç†ç”±': 'ãƒªãƒ¦ã‚¦', 'çµæœ': 'ã‚±ãƒƒã‚«',
            'ä¸–ç•Œ': 'ã‚»ã‚«ã‚¤', 'è‹±èª': 'ã‚¨ã‚¤ã‚´', 'å¸Œæœ›': 'ã‚­ãƒœã‚¦', 'å¹³å’Œ': 'ãƒ˜ã‚¤ãƒ¯',
            'è‡ªç”±': 'ã‚¸ãƒ¦ã‚¦', 'æœªæ¥': 'ãƒŸãƒ©ã‚¤', 'ç¾åœ¨': 'ã‚²ãƒ³ã‚¶ã‚¤', 'å±é™º': 'ã‚­ã‚±ãƒ³',
            'å®‰å…¨': 'ã‚¢ãƒ³ã‚¼ãƒ³', 'å¿…è¦': 'ãƒ’ãƒ„ãƒ¨ã‚¦', 'ç·Šæ€¥': 'ã‚­ãƒ³ã‚­ãƒ¥ã‚¦', 'é›»è©±': 'ãƒ‡ãƒ³ãƒ¯',
            'é›»è»Š': 'ãƒ‡ãƒ³ã‚·ãƒ£', 'å­¦æ ¡': 'ã‚¬ãƒƒã‚³ã‚¦', 'ä¼šç¤¾': 'ã‚«ã‚¤ã‚·ãƒ£', 'ç—…é™¢': 'ãƒ“ãƒ§ã‚¦ã‚¤ãƒ³',
            'å®¶æ—': 'ã‚«ã‚¾ã‚¯', 'å½¼å¥³': 'ã‚«ãƒã‚¸ãƒ§', 'ä¿¡å·': 'ã‚·ãƒ³ã‚´ã‚¦', 'åŠ©ã‘ã¦': 'ã‚¿ã‚¹ã‚±ãƒ†',
            'ãŠé¡˜ã„': 'ã‚ªãƒã‚¬ã‚¤', 'ä»Šæ—¥': 'ã‚­ãƒ§ã‚¦', 'æ˜æ—¥': 'ã‚¢ã‚·ã‚¿', 'æ˜¨æ—¥': 'ã‚­ãƒã‚¦',
            'è‰¯ã„': 'ãƒ¨ã‚¤', 'æ‚ªã„': 'ãƒ¯ãƒ«ã‚¤', 'å¤§ãã„': 'ã‚ªã‚ªã‚­ã‚¤', 'å°ã•ã„': 'ãƒã‚¤ã‚µã‚¤',
            'æ–°ã—ã„': 'ã‚¢ã‚¿ãƒ©ã‚·ã‚¤', 'å¤ã„': 'ãƒ•ãƒ«ã‚¤', 'é«˜ã„': 'ã‚¿ã‚«ã‚¤', 'æ¥½ã—ã„': 'ã‚¿ãƒã‚·ã‚¤',
            'å¬‰ã—ã„': 'ã‚¦ãƒ¬ã‚·ã‚¤', 'æ‚²ã—ã„': 'ã‚«ãƒŠã‚·ã‚¤', 'å„ªã—ã„': 'ãƒ¤ã‚µã‚·ã‚¤',
            'è¡Œã': 'ã‚¤ã‚¯', 'æ¥ã‚‹': 'ã‚¯ãƒ«', 'å¸°ã‚‹': 'ã‚«ã‚¨ãƒ«', 'è¦‹ã‚‹': 'ãƒŸãƒ«',
            'èã': 'ã‚­ã‚¯', 'è©±ã™': 'ãƒãƒŠã‚¹', 'è¨€ã†': 'ã‚¤ã‚¦', 'èª­ã‚€': 'ãƒ¨ãƒ ',
            'æ›¸ã': 'ã‚«ã‚¯', 'é£Ÿã¹ã‚‹': 'ã‚¿ãƒ™ãƒ«', 'é£²ã‚€': 'ãƒãƒ ', 'å¯ã‚‹': 'ãƒãƒ«',
            'èµ·ãã‚‹': 'ã‚ªã‚­ãƒ«', 'æ­©ã': 'ã‚¢ãƒ«ã‚¯', 'èµ°ã‚‹': 'ãƒã‚·ãƒ«', 'å¾…ã¤': 'ãƒãƒ„',
            'ä¼šã†': 'ã‚¢ã‚¦', 'æ€ã†': 'ã‚ªãƒ¢ã‚¦', 'çŸ¥ã‚‹': 'ã‚·ãƒ«', 'åˆ†ã‹ã‚‹': 'ãƒ¯ã‚«ãƒ«',
            'ä½œã‚‹': 'ãƒ„ã‚¯ãƒ«', 'ä½¿ã†': 'ãƒ„ã‚«ã‚¦', 'è²·ã†': 'ã‚«ã‚¦', 'å£²ã‚‹': 'ã‚¦ãƒ«',
            'æ•™ãˆã‚‹': 'ã‚ªã‚·ã‚¨ãƒ«', 'å­¦ã¶': 'ãƒãƒŠãƒ–', 'åƒã': 'ãƒã‚¿ãƒ©ã‚¯', 'ä¼‘ã‚€': 'ãƒ¤ã‚¹ãƒ ',
            'ä»Š': 'ã‚¤ãƒ', 'æ—¥': 'ãƒ’', 'æœˆ': 'ãƒ„ã‚­', 'å¹´': 'ãƒãƒ³', 'æ™‚': 'ã‚¸',
            'æœ': 'ã‚¢ã‚µ', 'æ˜¼': 'ãƒ’ãƒ«', 'å¤œ': 'ãƒ¨ãƒ«', 'é›¨': 'ã‚¢ãƒ¡', 'é›ª': 'ãƒ¦ã‚­',
            'é¢¨': 'ã‚«ã‚¼', 'ç©º': 'ã‚½ãƒ©', 'å±±': 'ãƒ¤ãƒ', 'å·': 'ã‚«ãƒ¯', 'æµ·': 'ã‚¦ãƒŸ',
            'ç§': 'ãƒ¯ã‚¿ã‚·', 'åƒ•': 'ãƒœã‚¯', 'å½¼': 'ã‚«ãƒ¬', 'äºº': 'ãƒ’ãƒˆ', 'ç”·': 'ã‚ªãƒˆã‚³',
            'å¥³': 'ã‚ªãƒ³ãƒŠ', 'å­': 'ã‚³', 'çˆ¶': 'ãƒãƒ', 'æ¯': 'ãƒãƒ', 'å®¶': 'ã‚¤ã‚¨',
            'å‹': 'ãƒˆãƒ¢', 'è»Š': 'ã‚¯ãƒ«ãƒ', 'æœ¬': 'ãƒ›ãƒ³', 'æ‰‹': 'ãƒ†', 'è¶³': 'ã‚¢ã‚·',
            'ç›®': 'ãƒ¡', 'è€³': 'ãƒŸãƒŸ', 'å£': 'ã‚¯ãƒ', 'é ­': 'ã‚¢ã‚¿ãƒ', 'é¡”': 'ã‚«ã‚ª',
            'å¿ƒ': 'ã‚³ã‚³ãƒ­', 'ä¸Š': 'ã‚¦ã‚¨', 'ä¸‹': 'ã‚·ã‚¿', 'ä¸­': 'ãƒŠã‚«', 'å¤–': 'ã‚½ãƒˆ',
            'å³': 'ãƒŸã‚®', 'å·¦': 'ãƒ’ãƒ€ãƒª', 'å‰': 'ãƒã‚¨', 'å¾Œ': 'ã‚¢ãƒˆ',
            'ä¸€': 'ã‚¤ãƒ', 'äºŒ': 'ãƒ‹', 'ä¸‰': 'ã‚µãƒ³', 'å››': 'ãƒ¨ãƒ³', 'äº”': 'ã‚´',
            'å…­': 'ãƒ­ã‚¯', 'ä¸ƒ': 'ãƒŠãƒŠ', 'å…«': 'ãƒãƒ', 'ä¹': 'ã‚­ãƒ¥ã‚¦', 'å': 'ã‚¸ãƒ¥ã‚¦',
            'ç™¾': 'ãƒ’ãƒ£ã‚¯', 'åƒ': 'ã‚»ãƒ³', 'ä¸‡': 'ãƒãƒ³', 'å††': 'ã‚¨ãƒ³',
            'æ„›': 'ã‚¢ã‚¤', 'å¤¢': 'ãƒ¦ãƒ¡', 'åŠ›': 'ãƒã‚«ãƒ©', 'å…‰': 'ãƒ’ã‚«ãƒª', 'æ˜Ÿ': 'ãƒ›ã‚·',
        };

        function kanjiToReading(text) {
            let result = '';
            let i = 0;
            while (i < text.length) {
                let matched = false;
                for (let len = Math.min(6, text.length - i); len > 0; len--) {
                    const substr = text.substring(i, i + len);
                    if (KANJI_DICT[substr]) {
                        result += KANJI_DICT[substr];
                        i += len;
                        matched = true;
                        break;
                    }
                }
                if (!matched) {
                    result += text[i];
                    i++;
                }
            }
            return result;
        }

        function getReading(text) {
            return hiraganaToKatakana(kanjiToReading(text));
        }

        function textToMorse(text) {
            let processedText = getReading(text).toUpperCase();
            let result = [];
            for (let char of processedText) {
                if (MORSE_CODE[char]) result.push(MORSE_CODE[char]);
                else if (MORSE_KANA[char]) result.push(MORSE_KANA[char]);
                else if (char === ' ' || char === 'ã€€') result.push('/');
            }
            return result.join(' ');
        }

        // DOMè¦ç´ 
        const micBtn = document.getElementById('micBtn');
        const voiceStatus = document.getElementById('voiceStatus');
        const recognizedText = document.getElementById('recognizedText');
        const autoPlayToggle = document.getElementById('autoPlayToggle');
        const permissionGuide = document.getElementById('permissionGuide');
        const textInput = document.getElementById('textInput');
        const morseOutput = document.getElementById('morseOutput');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const signalLight = document.getElementById('signalLight');
        const progressBar = document.getElementById('progressBar');
        const currentCharEl = document.getElementById('currentChar');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const freqSlider = document.getElementById('freqSlider');
        const freqValue = document.getElementById('freqValue');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const statusEl = document.getElementById('status');
        const readingSection = document.getElementById('readingSection');
        const readingTextEl = document.getElementById('readingText');
        const morseTable = document.getElementById('morseTable');
        const tabBtns = document.querySelectorAll('.tab-btn');

        let audioContext = null;
        let isPlaying = false;
        let stopRequested = false;
        let recognition = null;
        let isListening = false;
        let micPermissionGranted = false;
        let mediaStream = null;

        // éŸ³å£°èªè­˜APIã®ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
        function checkSpeechSupport() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                voiceStatus.textContent = 'âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«éå¯¾å¿œã§ã™';
                voiceStatus.classList.add('error');
                micBtn.classList.add('error');
                return false;
            }
            return true;
        }

        // ãƒã‚¤ã‚¯æ¨©é™ã‚’å–å¾—ï¼ˆgetUserMediaã‚’ä½¿ç”¨ï¼‰
        async function requestMicPermission() {
            voiceStatus.textContent = 'ğŸ¤ ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„...';
            voiceStatus.classList.add('warning');
            micBtn.classList.add('requesting');

            try {
                // getUserMediaã§ãƒã‚¤ã‚¯æ¨©é™ã‚’æ˜ç¤ºçš„ã«å–å¾—
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });
                
                // æ¨©é™å–å¾—æˆåŠŸ
                micPermissionGranted = true;
                permissionGuide.classList.remove('show');
                voiceStatus.classList.remove('warning');
                micBtn.classList.remove('requesting');
                
                console.log('ãƒã‚¤ã‚¯æ¨©é™å–å¾—æˆåŠŸ');
                return true;
                
            } catch (err) {
                console.error('ãƒã‚¤ã‚¯æ¨©é™ã‚¨ãƒ©ãƒ¼:', err);
                micPermissionGranted = false;
                micBtn.classList.remove('requesting');
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    voiceStatus.textContent = 'âŒ ãƒã‚¤ã‚¯ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“';
                    voiceStatus.classList.add('error');
                    permissionGuide.classList.add('show');
                } else if (err.name === 'NotFoundError') {
                    voiceStatus.textContent = 'âŒ ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    voiceStatus.classList.add('error');
                } else {
                    voiceStatus.textContent = 'âŒ ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: ' + err.message;
                    voiceStatus.classList.add('error');
                }
                
                return false;
            }
        }

        // éŸ³å£°èªè­˜ã‚’é–‹å§‹
        function startSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                console.log('éŸ³å£°èªè­˜é–‹å§‹');
                isListening = true;
                micBtn.classList.add('listening');
                micBtn.classList.remove('processing', 'requesting');
                voiceStatus.textContent = 'ğŸ¤ è©±ã—ã¦ãã ã•ã„...';
                voiceStatus.classList.remove('error', 'warning', 'success');
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    recognizedText.textContent = finalTranscript;
                    recognizedText.classList.remove('interim');
                    textInput.value = finalTranscript;
                    updateMorseOutput();
                    
                    voiceStatus.textContent = 'âœ… èªè­˜å®Œäº†ï¼';
                    voiceStatus.classList.add('success');
                    micBtn.classList.remove('listening');
                    micBtn.classList.add('processing');
                    
                    setTimeout(() => {
                        micBtn.classList.remove('processing');
                        voiceStatus.classList.remove('success');
                        voiceStatus.textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦è©±ã™';
                        
                        if (autoPlayToggle.checked && !isPlaying) {
                            playMorse();
                        }
                    }, 800);
                } else if (interimTranscript) {
                    recognizedText.textContent = interimTranscript;
                    recognizedText.classList.add('interim');
                    voiceStatus.textContent = 'ğŸ¤ èªè­˜ä¸­...';
                }
            };

            recognition.onerror = (event) => {
                console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
                isListening = false;
                micBtn.classList.remove('listening', 'processing');
                
                // not-allowedã®å ´åˆã¯æ¨©é™ã‚’å†å–å¾—
                if (event.error === 'not-allowed') {
                    micPermissionGranted = false;
                    voiceStatus.textContent = 'âŒ ãƒã‚¤ã‚¯æ¨©é™ãŒå¿…è¦ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„';
                    voiceStatus.classList.add('error');
                    permissionGuide.classList.add('show');
                } else if (event.error === 'no-speech') {
                    voiceStatus.textContent = 'éŸ³å£°ãŒèã“ãˆã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„';
                    voiceStatus.classList.add('warning');
                    setTimeout(() => {
                        voiceStatus.classList.remove('warning');
                        voiceStatus.textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦è©±ã™';
                    }, 3000);
                } else if (event.error === 'network') {
                    voiceStatus.textContent = 'âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                    voiceStatus.classList.add('error');
                } else {
                    voiceStatus.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + event.error;
                    voiceStatus.classList.add('error');
                }
            };

            recognition.onend = () => {
                console.log('éŸ³å£°èªè­˜çµ‚äº†');
                isListening = false;
                if (!micBtn.classList.contains('processing')) {
                    micBtn.classList.remove('listening');
                }
            };

            try {
                recognition.start();
                console.log('recognition.start() æˆåŠŸ');
            } catch (e) {
                console.error('recognition.start() ã‚¨ãƒ©ãƒ¼:', e);
                voiceStatus.textContent = 'âŒ éŸ³å£°èªè­˜ã‚’é–‹å§‹ã§ãã¾ã›ã‚“';
                voiceStatus.classList.add('error');
            }
        }

        // ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        async function handleMicClick() {
            if (!checkSpeechSupport()) return;

            // AudioContextåˆæœŸåŒ–
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            // ãƒªã‚¹ãƒ‹ãƒ³ã‚°ä¸­ãªã‚‰åœæ­¢
            if (isListening) {
                if (recognition) {
                    recognition.stop();
                }
                return;
            }

            // ãƒã‚¤ã‚¯æ¨©é™ãŒã¾ã ãªã‚‰å–å¾—
            if (!micPermissionGranted) {
                const granted = await requestMicPermission();
                if (!granted) {
                    return;
                }
            }

            // éŸ³å£°èªè­˜é–‹å§‹
            startSpeechRecognition();
        }

        // ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
        micBtn.addEventListener('click', handleMicClick);

        // ãƒ¢ãƒ¼ãƒ«ã‚¹å‡ºåŠ›æ›´æ–°
        function updateMorseOutput() {
            const text = textInput.value;
            if (!text) {
                morseOutput.textContent = '-';
                readingSection.style.display = 'none';
                statusEl.textContent = 'å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }

            const reading = getReading(text);
            const morse = textToMorse(text);
            morseOutput.textContent = morse || '-';

            if (/[\u4e00-\u9faf]/.test(text)) {
                readingSection.style.display = 'block';
                readingTextEl.textContent = reading;
            } else {
                readingSection.style.display = 'none';
            }

            const symbolCount = morse.split(' ').filter(m => m && m !== '/').length;
            statusEl.textContent = `${text.length}æ–‡å­— â†’ ${symbolCount}ã‚·ãƒ³ãƒœãƒ«`;
        }

        // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ç›£è¦–
        let inputTimeout;
        textInput.addEventListener('input', () => {
            clearTimeout(inputTimeout);
            inputTimeout = setTimeout(updateMorseOutput, 100);
        });

        // éŸ³å†ç”Ÿ
        async function playTone(duration) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = parseInt(freqSlider.value);
            oscillator.type = 'sine';
            
            const volume = parseInt(volumeSlider.value) / 100;
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime + duration / 1000 - 0.01);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
            
            signalLight.classList.add('active');
            
            return new Promise(resolve => {
                setTimeout(() => {
                    signalLight.classList.remove('active');
                    resolve();
                }, duration);
            });
        }

        function silence(duration) {
            return new Promise(resolve => setTimeout(resolve, duration));
        }

        async function playMorse() {
            if (isPlaying) return;
            
            const text = textInput.value;
            if (!text) {
                statusEl.textContent = 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            
            isPlaying = true;
            stopRequested = false;
            playBtn.disabled = true;
            statusEl.textContent = 'ğŸ”Š å†ç”Ÿä¸­...';
            statusEl.classList.add('playing');
            
            const wpm = parseInt(speedSlider.value);
            const dotDuration = 1200 / wpm;
            const dashDuration = dotDuration * 3;
            const symbolGap = dotDuration;
            const letterGap = dotDuration * 3;
            const wordGap = dotDuration * 7;
            
            const processedText = getReading(text).toUpperCase();
            
            let totalSymbols = 0;
            let currentSymbol = 0;
            
            for (let char of processedText) {
                if (MORSE_CODE[char] || MORSE_KANA[char]) totalSymbols++;
            }
            
            for (let i = 0; i < processedText.length; i++) {
                if (stopRequested) break;
                
                const char = processedText[i];
                const morse = MORSE_CODE[char] || MORSE_KANA[char];
                
                if (char === ' ' || char === 'ã€€') {
                    currentCharEl.textContent = 'â£';
                    await silence(wordGap);
                    continue;
                }
                
                if (!morse) continue;
                
                currentCharEl.textContent = char;
                currentSymbol++;
                progressBar.style.width = `${(currentSymbol / totalSymbols) * 100}%`;
                
                const symbols = morse.split('');
                
                for (let j = 0; j < symbols.length; j++) {
                    if (stopRequested) break;
                    
                    if (symbols[j] === '.') {
                        await playTone(dotDuration);
                    } else if (symbols[j] === '-') {
                        await playTone(dashDuration);
                    } else if (symbols[j] === ' ') {
                        await silence(symbolGap);
                    }
                    
                    if (j < symbols.length - 1 && symbols[j + 1] !== ' ') {
                        await silence(symbolGap);
                    }
                }
                
                if (i < processedText.length - 1) {
                    await silence(letterGap);
                }
            }
            
            isPlaying = false;
            playBtn.disabled = false;
            currentCharEl.textContent = '';
            progressBar.style.width = '0%';
            statusEl.classList.remove('playing');
            statusEl.textContent = stopRequested ? 'åœæ­¢ã—ã¾ã—ãŸ' : 'âœ… å†ç”Ÿå®Œäº†';
        }

        function stopMorse() {
            stopRequested = true;
            signalLight.classList.remove('active');
        }

        function clearAll() {
            textInput.value = '';
            morseOutput.textContent = '-';
            readingSection.style.display = 'none';
            recognizedText.textContent = '';
            statusEl.textContent = 'å…¥åŠ›ã—ã¦ãã ã•ã„';
            currentCharEl.textContent = '';
            progressBar.style.width = '0%';
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        playBtn.addEventListener('click', playMorse);
        stopBtn.addEventListener('click', stopMorse);
        clearBtn.addEventListener('click', clearAll);

        speedSlider.addEventListener('input', () => speedValue.textContent = speedSlider.value);
        freqSlider.addEventListener('input', () => freqValue.textContent = freqSlider.value);
        volumeSlider.addEventListener('input', () => volumeValue.textContent = volumeSlider.value + '%');

        // ãƒ¢ãƒ¼ãƒ«ã‚¹è¡¨
        function showMorseTable(type) {
            const table = type === 'alpha' ? MORSE_CODE : MORSE_KANA;
            const entries = Object.entries(table).filter(([c]) => c !== ' ');
            const displayEntries = type === 'alpha' ? entries.slice(0, 36) : entries.slice(0, 48);
            
            morseTable.innerHTML = displayEntries.map(([char, code]) => `
                <div class="morse-item">
                    <div class="char">${char}</div>
                    <div class="code">${code}</div>
                </div>
            `).join('');
        }

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                showMorseTable(btn.dataset.tab);
            });
        });

        // åˆæœŸåŒ–
        showMorseTable('alpha');
        checkSpeechSupport();
    </script>
</body>
</html>
